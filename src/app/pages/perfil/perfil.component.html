<h2>Mi Perfil</h2>

<div class="perfil-container">

  <div class="foto-section card">
    <h3>Foto de Perfil</h3>
    <div class="foto-display">
      @if (objectUrl()) {
        <img [src]="objectUrl()!" alt="Vista previa" class="profile-pic preview" width="150" height="150">
      }
      @else if (authService.currentUserFotoUrl()) {
        <img [ngSrc]="authService.currentUserFotoUrl()!" alt="Foto de perfil" class="profile-pic" width="150" height="150" priority>
      }
      @else {
        <div class="profile-pic placeholder">
          <span>{{ getUserInitials() }}</span>
        </div>
      }
    </div>

    <input type="file" #fileInput hidden (change)="onFileSelected($event)" accept="image/png, image/jpeg, image/gif">

    <div class="foto-actions">
      <button (click)="fileInput.click()" class="btn btn-secondary" [disabled]="subiendoFoto() || eliminandoFoto()">
        {{ subiendoFoto() ? 'Subiendo...' : 'Cambiar Foto' }}
      </button>
      @if (authService.currentUserFotoUrl() && !objectUrl()) { <button (click)="eliminarFoto()" class="btn btn-danger" [disabled]="subiendoFoto() || eliminandoFoto()">
          {{ eliminandoFoto() ? 'Eliminando...' : 'Eliminar Foto' }}
        </button>
      }
    </div>
    @if (errorFoto()) { <p class="error-msg">{{ errorFoto() }}</p> }
  </div>

  <div class="datos-section card">
    <h3>Datos Personales</h3>
    <form [formGroup]="nombreForm" (ngSubmit)="actualizarNombre()">
      <div class="form-group">
        <label for="nombre">Nombre</label>
        <input id="nombre" type="text" formControlName="nombre">
        @if (nombreForm.get('nombre')?.invalid && nombreForm.get('nombre')?.touched) {
          <small class="text-danger">El nombre es requerido.</small>
        }
      </div>
      <button type="submit" class="btn btn-primary" [disabled]="nombreForm.invalid || nombreForm.pristine || guardandoNombre()">
        {{ guardandoNombre() ? 'Guardando...' : 'Guardar Nombre' }}
      </button>
      @if (errorNombre()) { <p class="error-msg">{{ errorNombre() }}</p> }
    </form>

    <hr class="separator">

    <h3>Cambiar Contraseña</h3>
    <form [formGroup]="contraForm" (ngSubmit)="cambiarContrasena()">
       <div class="form-group">
         <label for="actual">Contraseña Actual</label>
         <input id="actual" type="password" formControlName="actual">
         @if (contraForm.get('actual')?.invalid && contraForm.get('actual')?.touched) {
          <small class="text-danger">La contraseña actual es requerida.</small>
        }
       </div>
       <div class="form-group">
         <label for="nueva">Nueva Contraseña</label>
         <input id="nueva" type="password" formControlName="nueva">
         @if (contraForm.get('nueva')?.invalid && contraForm.get('nueva')?.touched) {
           @if (contraForm.get('nueva')?.errors?.['required']) {
             <small class="text-danger">La nueva contraseña es requerida.</small>
           }
           @if (contraForm.get('nueva')?.errors?.['minlength']) {
             <small class="text-danger">Debe tener al menos 6 caracteres.</small>
           }
         }
       </div>
       <div class="form-group">
         <label for="confirmar">Confirmar Nueva Contraseña</label>
         <input id="confirmar" type="password" formControlName="confirmar">
         @if (contraForm.get('confirmar')?.invalid && contraForm.get('confirmar')?.touched) {
          <small class="text-danger">Confirma la nueva contraseña.</small>
         }
         @if (contraForm.errors?.['noCoinciden'] && contraForm.get('confirmar')?.touched) {
           <small class="text-danger">Las nuevas contraseñas no coinciden.</small>
         }
       </div>
       <button type="submit" class="btn btn-primary" [disabled]="contraForm.invalid || contraForm.pristine || guardandoContra()">
        {{ guardandoContra() ? 'Guardando...' : 'Cambiar Contraseña' }}
       </button>
       @if (errorContra()) { <p class="error-msg">{{ errorContra() }}</p> }
    </form>
  </div>
</div>

@if (mensajeExito()) {
  <div class="success-msg global-message">
      {{ mensajeExito() }}
  </div>
}